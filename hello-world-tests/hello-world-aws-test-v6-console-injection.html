<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AWS Evidence - Console Script Injection</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background-color: #f5f5f5; }
        .container { max-width: 1000px; margin: 0 auto; background: white; padding: 30px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; margin: -30px -30px 30px -30px; border-radius: 8px 8px 0 0; }
        .code-block { background-color: #2d3748; color: #e2e8f0; padding: 20px; border-radius: 5px; font-family: 'Consolas', 'Monaco', monospace; font-size: 14px; line-height: 1.6; overflow-x: auto; }
        .copy-button { background-color: #007bff; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; margin: 10px 0; }
        .copy-button:hover { background-color: #0056b3; }
        .success { background-color: #d4edda; color: #155724; padding: 15px; border-radius: 5px; margin: 10px 0; }
        .warning { background-color: #fff3cd; color: #856404; padding: 15px; border-radius: 5px; margin: 10px 0; }
        .step { margin: 20px 0; padding: 20px; border-left: 4px solid #007bff; background-color: #f8f9ff; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🚀 AWS Evidence - Console Script Injection</h1>
            <p><strong>CORS回避版：AWSコンソール内実行</strong></p>
        </div>
        
        <div class="warning">
            <h3>⚠️ CORS問題について:</h3>
            <p>AWS APIを外部サイトから直接呼び出すとCORSエラーが発生します。<br>
            これはセキュリティ上正常な動作です。</p>
        </div>

        <div class="success">
            <h3>✅ この方法の利点:</h3>
            <ul>
                <li><strong>CORSエラーなし</strong> - AWSコンソール内で実行</li>
                <li><strong>認証自動</strong> - ログイン済みセッション利用</li>
                <li><strong>制限なし</strong> - 企業環境でも確実に動作</li>
            </ul>
        </div>

        <div class="step">
            <h3>🎯 手順1: AWSコンソールを開く</h3>
            <p><a href="https://console.aws.amazon.com/console/home" target="_blank">AWS Management Console</a> を開いてください</p>
        </div>

        <div class="step">
            <h3>🔧 手順2: 開発者ツールでスクリプト実行</h3>
            <p>AWSコンソールページで F12 → Console タブ → 以下のコードを実行</p>
            
            <button class="copy-button" onclick="copyCode('console-test')">📋 コンソール内実行コードをコピー</button>
            
            <div class="code-block" id="console-test">
console.log('=== AWS Console Script Injection Test ===');

function testAWSConsoleAccess() {
    console.log('Testing AWS Console JavaScript access...');
    
    console.log('Current URL:', window.location.href);
    console.log('Domain:', window.location.hostname);
    
    if (window.location.hostname.includes('console.aws.amazon.com')) {
        console.log('✅ Running on AWS Console - Perfect!');
        
        console.log('Checking for AWS global objects...');
        console.log('window.AWS:', typeof window.AWS);
        console.log('window.awsConfig:', typeof window.awsConfig);
        console.log('window.region:', window.region || 'undefined');
        
        if (window.localStorage) {
            const awsKeys = Object.keys(window.localStorage).filter(key => 
                key.toLowerCase().includes('aws') || 
                key.toLowerCase().includes('credential') ||
                key.toLowerCase().includes('token')
            );
            console.log('AWS-related localStorage keys:', awsKeys);
        }
        
        if (window.sessionStorage) {
            const awsSessionKeys = Object.keys(window.sessionStorage).filter(key => 
                key.toLowerCase().includes('aws') || 
                key.toLowerCase().includes('credential') ||
                key.toLowerCase().includes('token')
            );
            console.log('AWS-related sessionStorage keys:', awsSessionKeys);
        }
        
        console.log('Checking document cookies...');
        const cookies = document.cookie.split(';').filter(cookie => 
            cookie.toLowerCase().includes('aws') ||
            cookie.toLowerCase().includes('session') ||
            cookie.toLowerCase().includes('auth')
        );
        console.log(`Found ${cookies.length} AWS-related cookies`);
        
        testNetworkRequests();
    } else {
        console.log('❌ Not running on AWS Console');
        console.log('Please run this script on console.aws.amazon.com');
    }
}

function testNetworkRequests() {
    console.log('\n=== Testing Network Requests ===');
    
    const originalFetch = window.fetch;
    window.fetch = function(...args) {
        console.log('Intercepted fetch request:', args[0]);
        return originalFetch.apply(this, args);
    };
    
    const originalXHR = window.XMLHttpRequest;
    const origOpen = originalXHR.prototype.open;
    originalXHR.prototype.open = function(method, url) {
        console.log('Intercepted XHR request:', method, url);
        origOpen.apply(this, arguments);
    };
    
    console.log('Network interception enabled');
    console.log('Now try using AWS services in the console...');
    
    setTimeout(() => {
        window.fetch = originalFetch;
        originalXHR.prototype.open = origOpen;
        console.log('Network interception disabled');
    }, 30000);
}

testAWSConsoleAccess();
            </div>
        </div>

        <div class="step">
            <h3>🔍 手順3: AWS API直接テスト</h3>
            <p>上記テストで情報を確認後、以下のコードでAWS APIを直接テスト：</p>
            
            <button class="copy-button" onclick="copyCode('api-test')">📋 API直接テストをコピー</button>
            
            <div class="code-block" id="api-test">
console.log('=== Direct AWS API Test from Console ===');

async function testDirectAPI() {
    try {
        console.log('Testing from AWS Console context...');
        
        const response = await fetch('/api/sts/GetCallerIdentity', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-amz-json-1.1',
                'X-Amz-Target': 'AWSSecurityTokenServiceV20110615.GetCallerIdentity'
            },
            credentials: 'same-origin'
        });
        
        console.log('Response status:', response.status);
        const data = await response.json();
        console.log('Response data:', data);
        
    } catch (error) {
        console.log('Direct API failed, trying alternative...');
        
        try {
            const proxyResponse = await fetch(window.location.origin + '/api/proxy', {
                method: 'POST',
                body: JSON.stringify({
                    service: 'sts',
                    action: 'GetCallerIdentity'
                }),
                headers: {
                    'Content-Type': 'application/json'
                },
                credentials: 'same-origin'
            });
            
            console.log('Proxy response:', proxyResponse.status);
            const proxyData = await proxyResponse.text();
            console.log('Proxy data:', proxyData);
            
        } catch (proxyError) {
            console.error('Both direct and proxy failed:', proxyError);
            console.log('Try manual AWS service navigation and check network tab');
        }
    }
}

testDirectAPI();
            </div>
        </div>

        <div class="step">
            <h3>📊 手順4: 実践的なデータ取得テスト</h3>
            <p>AWSコンソール内でサービスを実際に操作してネットワークトラフィックを確認：</p>
            
            <button class="copy-button" onclick="copyCode('practical-test')">📋 実践テストをコピー</button>
            
            <div class="code-block" id="practical-test">
console.log('=== Practical AWS Data Extraction ===');

function setupNetworkMonitoring() {
    const observer = new PerformanceObserver((list) => {
        list.getEntries().forEach((entry) => {
            if (entry.name.includes('amazonaws.com') || 
                entry.name.includes('/api/') ||
                entry.name.includes('sts') ||
                entry.name.includes('s3')) {
                console.log('AWS API Call detected:');
                console.log('URL:', entry.name);
                console.log('Duration:', entry.duration);
                console.log('Type:', entry.entryType);
            }
        });
    });
    
    observer.observe({ entryTypes: ['resource', 'navigation'] });
    
    console.log('Network monitoring active');
    console.log('Now navigate to AWS services (S3, EC2, etc.) in the console');
    console.log('API calls will be logged here');
    
    return observer;
}

const monitor = setupNetworkMonitoring();

console.log('To stop monitoring, run: monitor.disconnect()');
            </div>
        </div>

        <div class="warning">
            <h3>⚠️ 重要:</h3>
            <ul>
                <li>このスクリプトは<strong>AWSコンソール内でのみ</strong>実行してください</li>
                <li>ネットワークタブでAWS APIコールのパターンを確認できます</li>
                <li>実際のデータは手動でAWSサービスを操作した際に取得されます</li>
            </ul>
        </div>
    </div>

    <script>
        function copyCode(elementId) {
            const codeElement = document.getElementById(elementId);
            const text = codeElement.textContent;
            
            navigator.clipboard.writeText(text).then(() => {
                const button = event.target;
                const originalText = button.textContent;
                button.textContent = '✅ コピー完了!';
                button.style.backgroundColor = '#28a745';
                
                setTimeout(() => {
                    button.textContent = originalText;
                    button.style.backgroundColor = '#007bff';
                }, 2000);
            }).catch(() => {
                alert('手動でコードを選択してコピーしてください');
            });
        }
    </script>
</body>
</html>